# Webhooks Guide

Codebot can automatically respond to PR review comments by making code changes or answering questions.

## Overview

The webhook server listens for GitHub events and:
- Receives PR review comments
- Classifies them as queries or change requests
- Responds with answers or code changes
- Updates PR descriptions after changes

## Setup

### 1. Start Webhook Server

```bash
export GITHUB_APP_ID="123456"
export GITHUB_APP_PRIVATE_KEY_PATH="./codebot-private-key.pem"
export GITHUB_APP_INSTALLATION_ID="789012"
export GITHUB_WEBHOOK_SECRET="your_webhook_secret"

codebot serve --port 5000
```

### 2. Expose Server (Development)

For local testing, use a tool like [ngrok](https://ngrok.com):

```bash
ngrok http 5000
```

This gives you a public URL like `https://abc123.ngrok.io`.

### 3. Configure GitHub Webhook

1. Go to your repository **Settings** ‚Üí **Webhooks**
2. Click **Add webhook**
3. Configure:
   - **Payload URL**: `https://your-server.com/webhook`
   - **Content type**: `application/json`
   - **Secret**: Same as `GITHUB_WEBHOOK_SECRET`
   - **Events**: Select individual events:
     - ‚úÖ Issue comments
     - ‚úÖ Pull request reviews
     - ‚úÖ Pull request review comments
4. Click **Add webhook**

### 4. Verify Setup

Check the health endpoint:

```bash
curl http://localhost:5000/health
```

Response:

```json
{
  "status": "healthy",
  "review_queue_size": 0
}
```

## How It Works

### Comment Types

Codebot handles three types of PR comments:

1. **Inline code comments** (`pull_request_review_comment`)
   - Comments on specific lines of code
   - Includes file, line, and diff context

2. **Review summaries** (`pull_request_review`)
   - Overall review with approval/changes requested
   - May include general feedback

3. **General PR comments** (`issue_comment`)
   - Comments on the PR conversation
   - Not tied to specific code

### Processing Flow

When a reviewer leaves a comment:

1. **Webhook Receives Event** - GitHub sends webhook payload
2. **Signature Verification** - Validates request authenticity
3. **Queue Comment** - Adds to FIFO queue for processing
4. **Classify Comment** - Uses Claude AI to determine intent:
   - **Query**: Asking a question ‚Üí Answer without code changes
   - **Change Request**: Requesting changes ‚Üí Make changes and commit
   - **Ambiguous**: Unclear intent ‚Üí Ask for clarification
5. **Process with Claude** - Provides full context:
   - PR title and description
   - Files changed
   - Comment location (file, line, diff)
   - Previous comment thread
6. **Respond** - Posts reply to GitHub
7. **Update PR** (if changes made) - Refreshes PR description

### Comment Classification

Codebot uses Claude AI to intelligently classify comments:

**Query/Question Examples:**
- "Why did you choose this approach?"
- "What does this parameter do?"
- "How does this function work?"

**Change Request Examples:**
- "Please add error handling here"
- "This should use async/await"
- "Remove this console.log"

**Ambiguous Examples:**
- "This could be better"
- "Not sure about this"
- "Hmm..."

For ambiguous comments, codebot asks for clarification:

> ü§î Could you clarify what you'd like me to do?
>
> Please clarify if you'd like me to:
> - **Answer a question** about the code
> - **Make specific changes** to the code

## Context Provided to Claude

When processing comments, Claude receives:

- **PR Information**
  - Title and description
  - List of files changed

- **Comment Location** (for inline comments)
  - File path
  - Line number
  - Diff hunk (surrounding code)

- **Comment Thread**
  - Previous comments in the thread
  - Full conversation history

- **Repository Context**
  - CLAUDE.md file (if present)
  - Project conventions

This rich context allows Claude to provide accurate, contextual responses.

## Workspace Reuse

Codebot reuses workspaces for efficiency:

1. First comment on a PR ‚Üí Clone repository
2. Subsequent comments ‚Üí Reuse existing workspace
3. Pull latest changes before processing
4. Workspace identified by UUID in branch name

## PR Description Updates

After making changes, codebot automatically updates the PR description:

- Uses Claude to analyze the full diff
- Generates a unified, cohesive description
- Focuses on what was built, not individual commits
- Simplifies file list (only shows names, omits if >5 files)

Example updated PR:

```markdown
## üìã Task Description

Add dark mode support to the application

## üî® Changes Made

Implemented a comprehensive dark mode feature with automatic theme detection...

## üìÅ Files Changed

- `src/theme.ts`
- `src/components/ThemeToggle.tsx`
- `src/styles/dark.css`

---
*This PR was automatically generated by codebot ü§ñ*
```

## Recursion Prevention

Codebot ignores its own comments to avoid infinite loops:

- Checks for signature: `Reply generated by codebot ü§ñ`
- Filters out before processing
- Works with both PATs and GitHub Apps

## FIFO Queue Processing

Multiple review comments are processed sequentially:

- **First In, First Out** order
- Prevents conflicts between concurrent changes
- Ensures predictable processing
- Maintains stable workspace state

## Required GitHub Permissions

The GitHub token needs these permissions:

**Classic Token:**
- ‚úÖ `repo` (full repository access)

**Fine-Grained Token:**
- ‚úÖ **Pull requests**: Read and Write
- ‚úÖ **Contents**: Read and Write
- ‚úÖ **Metadata**: Read (automatic)

See [Configuration Guide](configuration.md#github-permissions) for details.

## Development Mode

Enable auto-reload for development:

```bash
codebot serve --port 5000 --debug
```

Features:
- Auto-restart on code changes
- Detailed error pages
- Verbose logging

**Note**: Never use `--debug` in production.

## Troubleshooting

For webhook issues, signature verification problems, and comment processing errors, see the [Troubleshooting Guide](troubleshooting.md).

## Best Practices

1. **Use webhook secrets** - Always set `GITHUB_WEBHOOK_SECRET`
2. **Monitor queue size** - Check `/health` endpoint regularly
3. **Test locally first** - Use ngrok for development
4. **Review logs** - Monitor server output for issues
5. **Set up alerts** - Monitor for failed webhook deliveries

## Real-World Examples

See Codebot in action with these example pull requests:

- **[PR #3: Confetti Feature](https://github.com/ajibigad/codebot-playground/pull/3)** - Demonstrates how Codebot handles review comments, makes code changes, and updates PR descriptions based on feedback
- **[PR #4: Calculator Enhancement](https://github.com/ajibigad/codebot-playground/pull/4)** - Shows Codebot responding to questions about code implementation and providing detailed explanations

These PRs showcase:
- Initial task execution and PR creation
- Responding to review comments with code changes
- Answering questions about implementation details
- Automatic PR description updates after changes
- Comment thread management

## Next Steps

- [Configuration Guide](configuration.md) - Environment variables and settings
- [HTTP API Guide](http-api.md) - Programmatic task submission
- [Architecture](architecture.md) - How codebot works internally

---

[‚Üê Back to Documentation](index.md)

